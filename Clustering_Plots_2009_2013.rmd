---
title: "Covariate clearing"
author: "Insang Song"
date: 01-09-2022
theme: "spacelab"
output:
  html_document:
    toc: true
    fig_caption: true
---

```{r}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```




```{r}
if (!require(pacman)) { install.packages('pacman') } 
options(repos = 'https://cran.seoul.go.kr')
p_load(tidyverse, sf, stars, raster, starsExtra, readxl, here, spdep, missRanger, GGally, smerc, DClusterm)
p_load(tidyverse, sf, spdep, DCluster, tmap, smerc, knitr, readxl, kableExtra, DClusterm, patchwork)
username = 'isong'
basedir = sprintf('/mnt/c/Users/%s/Documents/', username)
rdatafiles = list.files(path = str_c(basedir, 'GP/'), pattern = '*.RData', full.names = TRUE)

dbdir = here::here()
source('./base_functions.R')


drive <- str_c(basedir, "OneDrive/NCC_Project/CancerClustering/")
geopath <- str_c(basedir, "OneDrive/Data/Korea/")

```


```{r data munging, include = FALSE, eval = FALSE}
# incidence
inc <- read.csv(paste(drive, "cancerInc_sgg.csv", sep = ""), fileEncoding = "EUC-KR")
mor_to <- read.csv(paste(drive, "cancerMor_sgg_total.csv", sep = ""), fileEncoding = "EUC-KR")
mor_me <- read.csv(paste(drive, "cancerMor_sgg_male.csv", sep = ""), fileEncoding = "EUC-KR")
mor_fe <- read.csv(paste(drive, "cancerMor_sgg_female.csv", sep = ""), fileEncoding = "EUC-KR")

conv_table = read.csv(paste(geopath, 'SGG_1995_2018_Conversion_Table_201108.csv', sep = ''), fileEncoding = 'EUC-KR')
# total population for the expected values
# sex code: 0(all), 1(male), 2(female)
pop <- read.csv(paste(drive, "Midyear_Population_1998_2019.csv", sep = ""), fileEncoding = "UTF-8") %>%
    mutate(
        sex0 = plyr::mapvalues(sex0, c(0, 1, 2), c("T", "M", "F")),
        sex_e = plyr::mapvalues(sex0, c("T", "M", "F"), c("Total", "Male", "Female")),
        population = as.numeric(population)
    )
pop_wide = pop %>%
    pivot_wider(names_from = c("sex0", "year"), values_from = population)

colnames(inc) <- c("sex0", "sex", "cancer_type0", "cancer_type", "sgg_cd", "sgg_nm", "year0", "year", "inc0", "type_inc", "unit", "n", "x")
colnames(mor_to) <- c("cause0", "cause", "sgg_cd", "sgg_nm", "sex0", "sex", "type0", "type", "unit", paste("Y", 1998:2019, sep = ""), "x")
colnames(mor_me) <- c("cause0", "cause", "sgg_cd", "sgg_nm", "sex0", "sex", "type0", "type", "unit", paste("Y", 1998:2019, sep = ""), "x")
colnames(mor_fe) <- c("cause0", "cause", "sgg_cd", "sgg_nm", "sex0", "sex", "type0", "type", "unit", paste("Y", 1998:2019, sep = ""), "x")


## Data preprocessing ####
sgg <- st_read(paste(geopath, "SGG_Merge_2000_2016.shp", sep = ""))
sgg2010 <- sgg %>%
    filter(BASE_YEAR == 2010)
conv_table_e = conv_table %>%
    filter(from_year >= 1999 & from_year <= 2013) %>%
    dplyr::select(fromcode, tocode)

pop_cl = pop %>%
    mutate(sgg_cd = plyr::mapvalues(sgg_cd, conv_table_e$fromcode, conv_table_e$tocode),
           year_agg = cut(year, breaks = c(1998,2003,2008,2013,2018,2019), labels = c('1999-2003', '2004-2008', '2009-2013', '2014-2018', '2019'), right = TRUE)) %>%
    group_by(year_agg, sgg_cd, sex0, sex_e) %>%
    summarize(population = sum(population, na.rm = TRUE)) %>%
    ungroup


inc_cl <- inc %>%
    mutate(
        n_n = as.numeric(n),
        n_n = ifelse(is.na(n_n), 0, n_n),
        cancer_type_e = plyr::mapvalues(cancer_type, unique(cancer_type), c("Stomach", "Colorectal", "Liver", "Lung", "Breast", "Cervical", "Prostate", "Thyroid")),
        sex_e = plyr::mapvalues(sex, unique(sex), c("Total", "Male", "Female")),
        type_inc_e = plyr::mapvalues(type_inc, unique(type_inc), c("N", "r_crude", "r_agest")),
        sgg_cd_c = plyr::mapvalues(sgg_cd, conv_table_e$fromcode, conv_table_e$tocode)
    ) %>%
    # not sum
    pivot_wider(id_cols = c(year, sgg_cd_c, cancer_type_e, sex_e), names_from = type_inc_e, values_from = n_n, values_fn = sum) %>%
    # note that sex-specific cancers have incorrect crude rates
    left_join(pop_cl, by = c('year' = 'year_agg', 'sgg_cd_c' = 'sgg_cd', 'sex_e' = 'sex_e')) %>%
    group_by(year, sgg_cd_c, cancer_type_e, sex_e) %>%
    summarize(Ntotal = sum(N, na.rm = T),
              r_crude = sum(r_crude * (population / sum(population, na.rm = T)), na.rm = T)) %>%
    ungroup %>%
    pivot_longer(cols = 5:6, values_to = 'n_n', names_to = 'type_inc_e')

# summary table
inc_cl_summary <- inc_cl %>%
    group_by(cancer_type_e, year, sex_e, type_inc_e) %>%
    summarize(
        n_nmin = min(n_n),
        n_nmedian = median(n_n),
        n_nmean = mean(n_n),
        n_nmax = max(n_n)
    ) %>%
    ungroup() %>%
    pivot_longer(cols = 5:8) %>%
    pivot_wider(names_from = c("sex_e", "name"))

mor_cl = bind_rows(mor_to, mor_me) %>%
    bind_rows(mor_fe) %>%
    pivot_longer(cols = Y1998:Y2019) %>%
    mutate(year = as.integer(str_sub(name, 2, 5)),
           year_agg = cut(year, breaks = c(1998,2003,2008,2013,2018,2019), labels = c('1999-2003', '2004-2008', '2009-2013', '2014-2018', '2019'), right = TRUE),
           cancer_type_e = plyr::mapvalues(cause, unique(cause), c("Stomach", "Colorectal", "Liver", "Lung/Bronchus", "Breast", "Cervical/Uterine", "Prostate")),
           sex_e = plyr::mapvalues(sex, unique(sex), c('Total', 'Male', 'Female')),
           type_mor_e = plyr::mapvalues(type0, c('T1', 'T4', 'T7'), c('N', 'r_crude', 'r_agest')),
           sgg_cd_c = plyr::mapvalues(sgg_cd, conv_table_e$fromcode, conv_table_e$tocode)
        ) %>%
    # not sum
    pivot_wider(id_cols = c(year_agg, sgg_cd_c, cancer_type_e, sex_e), names_from = type_mor_e, values_from = value, values_fn = sum) %>%
    left_join(pop_cl, by = c('year_agg' = 'year_agg', 'sgg_cd_c' = 'sgg_cd', 'sex_e' = 'sex_e')) %>%
    group_by(year_agg, sgg_cd_c, cancer_type_e, sex_e) %>%
    summarize(Ntotal = sum(N, na.rm = T),
              r_crude = 1e5 * sum(N, na.rm = T)/sum(population, na.rm = T)) %>%
    ungroup %>%
    filter(year_agg %in% c('1999-2003', '2004-2008', '2009-2013'))



inc_clgg_n = inc_cl %>%
    filter(cancer_type_e %in% c('Lung', 'Stomach') & type_inc_e == 'Ntotal') %>%
    ggplot(data = .,
           mapping = aes(x = year, y = n_n, group = interaction(year, cancer_type_e, sex_e))) +
        facet_grid(sex_e ~ cancer_type_e) +
        geom_boxplot() +
        theme_bw() +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
        #scale_y_continuous(limits = c(0, 225)) +
        labs(subtitle = 'Crude cancer incidence counts by five-year periods and types')

inc_clgg_r = inc_cl %>%
    filter(cancer_type_e %in% c('Lung', 'Stomach') & type_inc_e == 'r_crude') %>%
    ggplot(data = .,
           mapping = aes(x = year, y = n_n, group = interaction(year, cancer_type_e, sex_e))) +
        facet_grid(sex_e ~ cancer_type_e) +
        geom_boxplot() +
        theme_bw() +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
        #scale_y_continuous(limits = c(0, 225)) +
        labs(subtitle = 'Crude cancer incidence rates per 100,000 persons by five-year periods and types')


mor_clgg_n = mor_cl %>%
    filter(cancer_type_e %in% c('Lung/Bronchus', 'Stomach')) %>%
    #left_join(pop, by = c('sgg_cd' = 'sgg_cd', 'year' = 'year', 'sex_e' = 'sex_e')) %>%
    #group_by(sgg_cd, cause, cancer_type_e, sex_e, year_agg) %>%
    #summarize(rate_100k_5yr = 1e5 * (sum(value, na.rm = T)/sum(population, na.rm = T))) %>%
    #ungroup %>%
    ggplot(data = .,
           mapping = aes(x= year_agg, y = Ntotal, group = interaction(year_agg, cancer_type_e, sex_e))) +
        facet_grid(sex_e ~ cancer_type_e) +
        geom_boxplot() +
        theme_bw() +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
        #scale_y_continuous(limits = c(0, 225)) +
        labs(subtitle = 'Cancer mortality counts by years and types')


mor_clgg_r = mor_cl %>%
    filter(cancer_type_e %in% c('Lung/Bronchus', 'Stomach')) %>%
    #left_join(pop, by = c('sgg_cd' = 'sgg_cd', 'year' = 'year', 'sex_e' = 'sex_e')) %>%
    #group_by(sgg_cd, cause, cancer_type_e, sex_e, year_agg) %>%
    #summarize(rate_100k_5yr = 1e5 * (sum(value, na.rm = T)/sum(population, na.rm = T))) %>%
    #ungroup %>%
    ggplot(data = .,
           mapping = aes(x= year_agg, y = r_crude, group = interaction(year_agg, cancer_type_e, sex_e))) +
        facet_grid(sex_e ~ cancer_type_e) +
        geom_boxplot() +
        theme_bw() +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
        #scale_y_continuous(limits = c(0, 225)) +
        labs(subtitle = 'Crude cancer mortality rates per 100,000 persons by years and types')

(inc_clgg_n | mor_clgg_n)

(inc_clgg_r | mor_clgg_r)


covar_origin_10 = get_basecovar(target_year = 2010)
#covar_origin_o = covar_origin_10
#colnames(covar_origin_10)[grep('^ap_sum_em_', colnames(covar_origin_10))] =
#    str_c('ap_sum_em_', c('co', 'nox', 'sox', 'tsp', 'pm10', 'voc', 'nh3'))
covar_origin_10_consol = clean_consolidated(cleaned_df = covar_origin_10) %>%
    mutate_at(.vars = vars(-geom),
              .funs = list(~ifelse(is.na(.), median(., na.rm = TRUE), .)))



```

```{r}
#load('Scan_SMERC_2009_2013_Results.RData')
#load('Scan_DCLUST_2009_2013_Results.RData')
load('Scan_2009_2013_Results.RData')

```

```{r include = FALSE, eval = FALSE}

test_ellipses = tmap_smerc(covar_origin_10_fc, smerc_lung_3dtu, return_ellipses = TRUE)
ggplot() + 
    geom_sf(data = test_ellipses, mapping = aes(), border = 'black')

```

# Overview
- Incidence and mortality rates: (Sum of cases) / (Sum of the population)
- 2009-2013: all covariates included


# Lung Cancer (2009-2013)
```{r}
tmap::tmap_arrange(
    tmap_smerc(covar_origin_10_fc, smerc_lung_3dtu, return_ellipses = TRUE) + 
        tm_layout(title = 'Lung cancer mortality\n(2009-2013, All sexes, Uncontrolled)', frame = FALSE),
    tmap_smerc(covar_origin_10_fc, smerc_lung_3dt, return_ellipses = TRUE) + 
        tm_layout(title = 'Lung cancer mortality\n(2009-2013, All sexes, Controlled)  ', frame = FALSE),
    ncol = 2
)

tmap::tmap_arrange(
    tmap_smerc(covar_origin_10_fc, smerc_lung_3itu, return_ellipses = TRUE) + 
        tm_layout(title = 'Lung cancer incidence\n(2009-2013, All sexes, Uncontrolled)', frame = FALSE),
    tmap_smerc(covar_origin_10_fc, smerc_lung_3it, return_ellipses = TRUE) + 
        tm_layout(title = 'Lung cancer incidence\n(2009-2013, All sexes, Controlled)  ', frame = FALSE),
    ncol = 2
)

tmap::tmap_arrange(
    tmap_smerc(covar_origin_10_fc, smerc_lung_3dfu, return_ellipses = TRUE) + 
        tm_layout(title = 'Lung cancer mortality\n(2009-2013, Female, Uncontrolled)', frame = FALSE),
    tmap_smerc(covar_origin_10_fc, smerc_lung_3df, return_ellipses = TRUE) + 
        tm_layout(title = 'Lung cancer mortality\n(2009-2013, Female, Controlled)  ', frame = FALSE),
    ncol = 2
)

tmap::tmap_arrange(
    tmap_smerc(covar_origin_10_fc, smerc_lung_3ifu, return_ellipses = TRUE) + 
        tm_layout(title = 'Lung cancer incidence\n(2009-2013, Female, Uncontrolled)', frame = FALSE),
    tmap_smerc(covar_origin_10_fc, smerc_lung_3if, return_ellipses = TRUE) + 
        tm_layout(title = 'Lung cancer incidence\n(2009-2013, Female, Controlled)  ', frame = FALSE),
    ncol = 2
)

tmap::tmap_arrange(
    tmap_smerc(covar_origin_10_fc, smerc_lung_3dmu, return_ellipses = TRUE) + 
        tm_layout(title = 'Lung cancer mortality\n(2009-2013, Male, Uncontrolled)', frame = FALSE),
    tmap_smerc(covar_origin_10_fc, smerc_lung_3dm, return_ellipses = TRUE) + 
        tm_layout(title = 'Lung cancer mortality\n(2009-2013, Male, Controlled)  ', frame = FALSE),
    ncol = 2
)

tmap::tmap_arrange(
    tmap_smerc(covar_origin_10_fc, smerc_lung_3imu, return_ellipses = TRUE) + 
        tm_layout(title = 'Lung cancer incidence\n(2009-2013, Male, Uncontrolled)', frame = FALSE),
    tmap_smerc(covar_origin_10_fc, smerc_lung_3im, return_ellipses = TRUE) + 
        tm_layout(title = 'Lung cancer incidence\n(2009-2013, Male, Controlled)  ', frame = FALSE),
    ncol = 2
)


```


# Stomach Cancer (2009-2013)

```{r}
tmap::tmap_arrange(
    tmap_smerc(covar_origin_10_fc, smerc_stom_3dtu, return_ellipses = TRUE) + 
        tm_layout(title = 'Stomach cancer mortality\n(2009-2013, All sexes, Uncontrolled)', frame = FALSE, main.title.size = 10),
    tmap_smerc(covar_origin_10_fc, smerc_stom_3dt, return_ellipses = TRUE) + 
        tm_layout(title = 'Stomach cancer mortality\n(2009-2013, All sexes, Controlled)  ', frame = FALSE, main.title.size = 10),
    ncol = 2
)

tmap::tmap_arrange(
    tmap_smerc(covar_origin_10_fc, smerc_stom_3itu, return_ellipses = TRUE) + 
        tm_layout(title = 'Stomach cancer incidence\n(2009-2013, All sexes, Uncontrolled)', frame = FALSE),
    tmap_smerc(covar_origin_10_fc, smerc_stom_3it, return_ellipses = TRUE) + 
        tm_layout(title = 'Stomach cancer incidence\n(2009-2013, All sexes, Controlled)  ', frame = FALSE),
    ncol = 2
)

tmap::tmap_arrange(
    tmap_smerc(covar_origin_10_fc, smerc_stom_3dfu, return_ellipses = TRUE) + 
        tm_layout(title = 'Stomach cancer mortality\n(2009-2013, Female, Uncontrolled)', frame = FALSE),
    tmap_smerc(covar_origin_10_fc, smerc_stom_3df, return_ellipses = TRUE) + 
        tm_layout(title = 'Stomach cancer mortality\n(2009-2013, Female, Controlled)  ', frame = FALSE),
    ncol = 2
)

tmap::tmap_arrange(
    tmap_smerc(covar_origin_10_fc, smerc_stom_3ifu, return_ellipses = TRUE) + 
        tm_layout(title = 'Stomach cancer incidence\n(2009-2013, Female, Uncontrolled)', frame = FALSE),
    tmap_smerc(covar_origin_10_fc, smerc_stom_3if, return_ellipses = TRUE) + 
        tm_layout(title = 'Stomach cancer incidence\n(2009-2013, Female, Controlled)  ', frame = FALSE),
    ncol = 2
)

tmap::tmap_arrange(
    tmap_smerc(covar_origin_10_fc, smerc_stom_3dmu, return_ellipses = TRUE) + 
        tm_layout(title = 'Stomach cancer mortality\n(2009-2013, Male, Uncontrolled)', frame = FALSE),
    tmap_smerc(covar_origin_10_fc, smerc_stom_3dm, return_ellipses = TRUE) + 
        tm_layout(title = 'Stomach cancer mortality\n(2009-2013, Male, Controlled)  ', frame = FALSE),
    ncol = 2
)

tmap::tmap_arrange(
    tmap_smerc(covar_origin_10_fc, smerc_stom_3imu, return_ellipses = TRUE) + 
        tm_layout(title = 'Stomach cancer incidence\n(2009-2013, Male, Uncontrolled)', frame = FALSE),
    tmap_smerc(covar_origin_10_fc, smerc_stom_3im, return_ellipses = TRUE) + 
        tm_layout(title = 'Stomach cancer incidence\n(2009-2013, Male, Controlled)  ', frame = FALSE),
    ncol = 2
)


```
